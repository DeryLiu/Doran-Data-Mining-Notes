
# 参考答案


```python
import pandas as pd
import numpy as np
```

## 第1章：练习一
### (a)


```python
df = pd.read_csv('data/Game_of_Thrones_Script.csv')
df.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Release Date</th>
      <th>Season</th>
      <th>Episode</th>
      <th>Episode Title</th>
      <th>Name</th>
      <th>Sentence</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2011/4/17</td>
      <td>Season 1</td>
      <td>Episode 1</td>
      <td>Winter is Coming</td>
      <td>waymar royce</td>
      <td>What do you expect? They're savages. One lot s...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2011/4/17</td>
      <td>Season 1</td>
      <td>Episode 1</td>
      <td>Winter is Coming</td>
      <td>will</td>
      <td>I've never seen wildlings do a thing like this...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2011/4/17</td>
      <td>Season 1</td>
      <td>Episode 1</td>
      <td>Winter is Coming</td>
      <td>waymar royce</td>
      <td>How close did you get?</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2011/4/17</td>
      <td>Season 1</td>
      <td>Episode 1</td>
      <td>Winter is Coming</td>
      <td>will</td>
      <td>Close as any man would.</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2011/4/17</td>
      <td>Season 1</td>
      <td>Episode 1</td>
      <td>Winter is Coming</td>
      <td>gared</td>
      <td>We should head back to the wall.</td>
    </tr>
  </tbody>
</table>
</div>




```python
df['Name'].nunique()
```




    564



### (b)


```python
df['Name'].value_counts().index[0]
```




    'tyrion lannister'



### (c) 由于还没有学分组，因此方法繁琐


```python
df_words = df.assign(Words=df['Sentence'].apply(lambda x:len(x.split()))).sort_values(by='Name')
df_words.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Release Date</th>
      <th>Season</th>
      <th>Episode</th>
      <th>Episode Title</th>
      <th>Name</th>
      <th>Sentence</th>
      <th>Words</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>276</th>
      <td>2011/4/17</td>
      <td>Season 1</td>
      <td>Episode 1</td>
      <td>Winter is Coming</td>
      <td>a voice</td>
      <td>It's Maester Luwin, my lord.</td>
      <td>5</td>
    </tr>
    <tr>
      <th>3012</th>
      <td>2011/6/19</td>
      <td>Season 1</td>
      <td>Episode 10</td>
      <td>Fire and Blood</td>
      <td>addam marbrand</td>
      <td>ls it true about Stannis and Renly?</td>
      <td>7</td>
    </tr>
    <tr>
      <th>3017</th>
      <td>2011/6/19</td>
      <td>Season 1</td>
      <td>Episode 10</td>
      <td>Fire and Blood</td>
      <td>addam marbrand</td>
      <td>Kevan Lannister</td>
      <td>2</td>
    </tr>
    <tr>
      <th>13610</th>
      <td>2014/6/8</td>
      <td>Season 4</td>
      <td>Episode 9</td>
      <td>The Watchers on the Wall</td>
      <td>aemon</td>
      <td>And what is it that couldn't wait until mornin...</td>
      <td>10</td>
    </tr>
    <tr>
      <th>13614</th>
      <td>2014/6/8</td>
      <td>Season 4</td>
      <td>Episode 9</td>
      <td>The Watchers on the Wall</td>
      <td>aemon</td>
      <td>Oh, no need. I know my way around this library...</td>
      <td>48</td>
    </tr>
  </tbody>
</table>
</div>




```python
L_count = []
N_words = list(zip(df_words['Name'],df_words['Words']))
for i in N_words:
    if i == N_words[0]:
        L_count.append(i[1])
        last = i[0]
    else:
        L_count.append(L_count[-1]+i[1] if i[0]==last else i[1])
        last = i[0]
df_words['Count']=L_count
df_words['Name'][df_words['Count'].idxmax()]
```




    'tyrion lannister'



## 第1章：练习二

### (a)


```python
df = pd.read_csv('data/Kobe_data.csv',index_col='shot_id')
df.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>action_type</th>
      <th>combined_shot_type</th>
      <th>game_event_id</th>
      <th>game_id</th>
      <th>lat</th>
      <th>loc_x</th>
      <th>loc_y</th>
      <th>lon</th>
      <th>minutes_remaining</th>
      <th>period</th>
      <th>...</th>
      <th>shot_made_flag</th>
      <th>shot_type</th>
      <th>shot_zone_area</th>
      <th>shot_zone_basic</th>
      <th>shot_zone_range</th>
      <th>team_id</th>
      <th>team_name</th>
      <th>game_date</th>
      <th>matchup</th>
      <th>opponent</th>
    </tr>
    <tr>
      <th>shot_id</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>Jump Shot</td>
      <td>Jump Shot</td>
      <td>10</td>
      <td>20000012</td>
      <td>33.9723</td>
      <td>167</td>
      <td>72</td>
      <td>-118.1028</td>
      <td>10</td>
      <td>1</td>
      <td>...</td>
      <td>NaN</td>
      <td>2PT Field Goal</td>
      <td>Right Side(R)</td>
      <td>Mid-Range</td>
      <td>16-24 ft.</td>
      <td>1610612747</td>
      <td>Los Angeles Lakers</td>
      <td>2000/10/31</td>
      <td>LAL @ POR</td>
      <td>POR</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Jump Shot</td>
      <td>Jump Shot</td>
      <td>12</td>
      <td>20000012</td>
      <td>34.0443</td>
      <td>-157</td>
      <td>0</td>
      <td>-118.4268</td>
      <td>10</td>
      <td>1</td>
      <td>...</td>
      <td>0.0</td>
      <td>2PT Field Goal</td>
      <td>Left Side(L)</td>
      <td>Mid-Range</td>
      <td>8-16 ft.</td>
      <td>1610612747</td>
      <td>Los Angeles Lakers</td>
      <td>2000/10/31</td>
      <td>LAL @ POR</td>
      <td>POR</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Jump Shot</td>
      <td>Jump Shot</td>
      <td>35</td>
      <td>20000012</td>
      <td>33.9093</td>
      <td>-101</td>
      <td>135</td>
      <td>-118.3708</td>
      <td>7</td>
      <td>1</td>
      <td>...</td>
      <td>1.0</td>
      <td>2PT Field Goal</td>
      <td>Left Side Center(LC)</td>
      <td>Mid-Range</td>
      <td>16-24 ft.</td>
      <td>1610612747</td>
      <td>Los Angeles Lakers</td>
      <td>2000/10/31</td>
      <td>LAL @ POR</td>
      <td>POR</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Jump Shot</td>
      <td>Jump Shot</td>
      <td>43</td>
      <td>20000012</td>
      <td>33.8693</td>
      <td>138</td>
      <td>175</td>
      <td>-118.1318</td>
      <td>6</td>
      <td>1</td>
      <td>...</td>
      <td>0.0</td>
      <td>2PT Field Goal</td>
      <td>Right Side Center(RC)</td>
      <td>Mid-Range</td>
      <td>16-24 ft.</td>
      <td>1610612747</td>
      <td>Los Angeles Lakers</td>
      <td>2000/10/31</td>
      <td>LAL @ POR</td>
      <td>POR</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Driving Dunk Shot</td>
      <td>Dunk</td>
      <td>155</td>
      <td>20000012</td>
      <td>34.0443</td>
      <td>0</td>
      <td>0</td>
      <td>-118.2698</td>
      <td>6</td>
      <td>2</td>
      <td>...</td>
      <td>1.0</td>
      <td>2PT Field Goal</td>
      <td>Center(C)</td>
      <td>Restricted Area</td>
      <td>Less Than 8 ft.</td>
      <td>1610612747</td>
      <td>Los Angeles Lakers</td>
      <td>2000/10/31</td>
      <td>LAL @ POR</td>
      <td>POR</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 24 columns</p>
</div>




```python
pd.Series(list(zip(df['action_type'],df['combined_shot_type']))).value_counts().index[0]
```




    ('Jump Shot', 'Jump Shot')



### (b)


```python
pd.Series(list(list(zip(*(pd.Series(list(zip(df['game_id'],df['opponent'])))
                          .unique()).tolist()))[1])).value_counts().index[0]
```




    'SAS'



## 第2章：练习一

### (a)


```python
df = pd.read_csv('data/UFO.csv')
df.rename(columns={'duration (seconds)':'duration'},inplace=True)
df['duration'].astype('float')
df.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>datetime</th>
      <th>shape</th>
      <th>duration</th>
      <th>latitude</th>
      <th>longitude</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>10/10/1949 20:30</td>
      <td>cylinder</td>
      <td>2700.0</td>
      <td>29.883056</td>
      <td>-97.941111</td>
    </tr>
    <tr>
      <th>1</th>
      <td>10/10/1949 21:00</td>
      <td>light</td>
      <td>7200.0</td>
      <td>29.384210</td>
      <td>-98.581082</td>
    </tr>
    <tr>
      <th>2</th>
      <td>10/10/1955 17:00</td>
      <td>circle</td>
      <td>20.0</td>
      <td>53.200000</td>
      <td>-2.916667</td>
    </tr>
    <tr>
      <th>3</th>
      <td>10/10/1956 21:00</td>
      <td>circle</td>
      <td>20.0</td>
      <td>28.978333</td>
      <td>-96.645833</td>
    </tr>
    <tr>
      <th>4</th>
      <td>10/10/1960 20:00</td>
      <td>light</td>
      <td>900.0</td>
      <td>21.418056</td>
      <td>-157.803611</td>
    </tr>
  </tbody>
</table>
</div>




```python
df.query('duration > 60')['shape'].value_counts().index[0]
```




    'light'



### (b)


```python
bins_long = np.linspace(-180,180,13).tolist()
bins_la = np.linspace(-90,90,11).tolist()
cuts_long = pd.cut(df['longitude'],bins=bins_long)
df['cuts_long'] = cuts_long
cuts_la = pd.cut(df['latitude'],bins=bins_la)
df['cuts_la'] = cuts_la
df.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>datetime</th>
      <th>shape</th>
      <th>duration</th>
      <th>latitude</th>
      <th>longitude</th>
      <th>cuts_long</th>
      <th>cuts_la</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>10/10/1949 20:30</td>
      <td>cylinder</td>
      <td>2700.0</td>
      <td>29.883056</td>
      <td>-97.941111</td>
      <td>(-120.0, -90.0]</td>
      <td>(18.0, 36.0]</td>
    </tr>
    <tr>
      <th>1</th>
      <td>10/10/1949 21:00</td>
      <td>light</td>
      <td>7200.0</td>
      <td>29.384210</td>
      <td>-98.581082</td>
      <td>(-120.0, -90.0]</td>
      <td>(18.0, 36.0]</td>
    </tr>
    <tr>
      <th>2</th>
      <td>10/10/1955 17:00</td>
      <td>circle</td>
      <td>20.0</td>
      <td>53.200000</td>
      <td>-2.916667</td>
      <td>(-30.0, 0.0]</td>
      <td>(36.0, 54.0]</td>
    </tr>
    <tr>
      <th>3</th>
      <td>10/10/1956 21:00</td>
      <td>circle</td>
      <td>20.0</td>
      <td>28.978333</td>
      <td>-96.645833</td>
      <td>(-120.0, -90.0]</td>
      <td>(18.0, 36.0]</td>
    </tr>
    <tr>
      <th>4</th>
      <td>10/10/1960 20:00</td>
      <td>light</td>
      <td>900.0</td>
      <td>21.418056</td>
      <td>-157.803611</td>
      <td>(-180.0, -150.0]</td>
      <td>(18.0, 36.0]</td>
    </tr>
  </tbody>
</table>
</div>




```python
df.set_index(['cuts_long','cuts_la']).index.value_counts().head()
```




    ((-90.0, -60.0], (36.0, 54.0])      27891
    ((-120.0, -90.0], (18.0, 36.0])     14280
    ((-120.0, -90.0], (36.0, 54.0])     11960
    ((-90.0, -60.0], (18.0, 36.0])       9923
    ((-150.0, -120.0], (36.0, 54.0])     9658
    dtype: int64



## 第2章：练习二

### (a)


```python
df = pd.read_csv('data/Pokemon.csv')
df.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>#</th>
      <th>Name</th>
      <th>Type 1</th>
      <th>Type 2</th>
      <th>Total</th>
      <th>HP</th>
      <th>Attack</th>
      <th>Defense</th>
      <th>Sp. Atk</th>
      <th>Sp. Def</th>
      <th>Speed</th>
      <th>Generation</th>
      <th>Legendary</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>Bulbasaur</td>
      <td>Grass</td>
      <td>Poison</td>
      <td>318</td>
      <td>45</td>
      <td>49</td>
      <td>49</td>
      <td>65</td>
      <td>65</td>
      <td>45</td>
      <td>1</td>
      <td>False</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>Ivysaur</td>
      <td>Grass</td>
      <td>Poison</td>
      <td>405</td>
      <td>60</td>
      <td>62</td>
      <td>63</td>
      <td>80</td>
      <td>80</td>
      <td>60</td>
      <td>1</td>
      <td>False</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>Venusaur</td>
      <td>Grass</td>
      <td>Poison</td>
      <td>525</td>
      <td>80</td>
      <td>82</td>
      <td>83</td>
      <td>100</td>
      <td>100</td>
      <td>80</td>
      <td>1</td>
      <td>False</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
      <td>VenusaurMega Venusaur</td>
      <td>Grass</td>
      <td>Poison</td>
      <td>625</td>
      <td>80</td>
      <td>100</td>
      <td>123</td>
      <td>122</td>
      <td>120</td>
      <td>80</td>
      <td>1</td>
      <td>False</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4</td>
      <td>Charmander</td>
      <td>Fire</td>
      <td>NaN</td>
      <td>309</td>
      <td>39</td>
      <td>52</td>
      <td>43</td>
      <td>60</td>
      <td>50</td>
      <td>65</td>
      <td>1</td>
      <td>False</td>
    </tr>
  </tbody>
</table>
</div>




```python
df['Type 2'].count()/df.shape[0]
```




    0.5175



### (b)


```python
df.query('Total >= 580')['Legendary'].value_counts(normalize=True)
```




    True     0.575221
    False    0.424779
    Name: Legendary, dtype: float64



### (c) 分别为Maga形态的路卡利欧、修缮老头、怪力


```python
df[df['Type 1']=='Fighting'].sort_values(by='Attack',ascending=False).iloc[:3]
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>#</th>
      <th>Name</th>
      <th>Type 1</th>
      <th>Type 2</th>
      <th>Total</th>
      <th>HP</th>
      <th>Attack</th>
      <th>Defense</th>
      <th>Sp. Atk</th>
      <th>Sp. Def</th>
      <th>Speed</th>
      <th>Generation</th>
      <th>Legendary</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>498</th>
      <td>448</td>
      <td>LucarioMega Lucario</td>
      <td>Fighting</td>
      <td>Steel</td>
      <td>625</td>
      <td>70</td>
      <td>145</td>
      <td>88</td>
      <td>140</td>
      <td>70</td>
      <td>112</td>
      <td>4</td>
      <td>False</td>
    </tr>
    <tr>
      <th>594</th>
      <td>534</td>
      <td>Conkeldurr</td>
      <td>Fighting</td>
      <td>NaN</td>
      <td>505</td>
      <td>105</td>
      <td>140</td>
      <td>95</td>
      <td>55</td>
      <td>65</td>
      <td>45</td>
      <td>5</td>
      <td>False</td>
    </tr>
    <tr>
      <th>74</th>
      <td>68</td>
      <td>Machamp</td>
      <td>Fighting</td>
      <td>NaN</td>
      <td>505</td>
      <td>90</td>
      <td>130</td>
      <td>80</td>
      <td>65</td>
      <td>85</td>
      <td>55</td>
      <td>1</td>
      <td>False</td>
    </tr>
  </tbody>
</table>
</div>



### (d) 钢系的极差均值最大


```python
df['range'] = df.iloc[:,5:11].max(axis=1)-df.iloc[:,5:11].min(axis=1)
attribute = df[['Type 1','range']].set_index('Type 1')
max_range = 0
result = ''
for i in attribute.index.unique():
    temp = attribute.loc[i,:].mean()
    if temp.values[0] > max_range:
        max_range = temp.values[0]
        result = i
result
```




    'Steel'



### (e) 超能系占比最高，但普通系均值最高（因为创世神的关系）


```python
df.query('Legendary == True')['Type 1'].value_counts(normalize=True).index[0]
```




    'Psychic'




```python
attribute = df.query('Legendary == True')[['Type 1','Total']].set_index('Type 1')
max_value = 0
result = ''
for i in attribute.index.unique():
    temp = float(attribute.loc[i,:].mean())
    if temp > max_value:
        max_value = temp
        result = i
result
```




    'Normal'



## 第3章：练习一

### (a) 极差为17561


```python
df = pd.read_csv('data/Diamonds.csv')
df.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>carat</th>
      <th>color</th>
      <th>depth</th>
      <th>price</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.23</td>
      <td>E</td>
      <td>61.5</td>
      <td>326</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.21</td>
      <td>E</td>
      <td>59.8</td>
      <td>326</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.23</td>
      <td>E</td>
      <td>56.9</td>
      <td>327</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.29</td>
      <td>I</td>
      <td>62.4</td>
      <td>334</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.31</td>
      <td>J</td>
      <td>63.3</td>
      <td>335</td>
    </tr>
  </tbody>
</table>
</div>




```python
df_r = df.query('carat>1')['price']
df_r.max()-df_r.min()
```




    17561



### (b) 0-0.2分位数区间最多的为‘E’，其余区间都为‘G’


```python
bins = df['depth'].quantile(np.linspace(0,1,6)).tolist()
cuts = pd.cut(df['depth'],bins=bins) #可选label添加自定义标签
df['cuts'] = cuts
df.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>carat</th>
      <th>color</th>
      <th>depth</th>
      <th>price</th>
      <th>cuts</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.23</td>
      <td>E</td>
      <td>61.5</td>
      <td>326</td>
      <td>(60.8, 61.6]</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.21</td>
      <td>E</td>
      <td>59.8</td>
      <td>326</td>
      <td>(43.0, 60.8]</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.23</td>
      <td>E</td>
      <td>56.9</td>
      <td>327</td>
      <td>(43.0, 60.8]</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.29</td>
      <td>I</td>
      <td>62.4</td>
      <td>334</td>
      <td>(62.1, 62.7]</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.31</td>
      <td>J</td>
      <td>63.3</td>
      <td>335</td>
      <td>(62.7, 79.0]</td>
    </tr>
  </tbody>
</table>
</div>




```python
color_result = df.groupby('cuts')['color'].describe()
color_result
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>count</th>
      <th>unique</th>
      <th>top</th>
      <th>freq</th>
    </tr>
    <tr>
      <th>cuts</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>(43.0, 60.8]</th>
      <td>11294</td>
      <td>7</td>
      <td>E</td>
      <td>2259</td>
    </tr>
    <tr>
      <th>(60.8, 61.6]</th>
      <td>11831</td>
      <td>7</td>
      <td>G</td>
      <td>2593</td>
    </tr>
    <tr>
      <th>(61.6, 62.1]</th>
      <td>10403</td>
      <td>7</td>
      <td>G</td>
      <td>2247</td>
    </tr>
    <tr>
      <th>(62.1, 62.7]</th>
      <td>10137</td>
      <td>7</td>
      <td>G</td>
      <td>2193</td>
    </tr>
    <tr>
      <th>(62.7, 79.0]</th>
      <td>10273</td>
      <td>7</td>
      <td>G</td>
      <td>2000</td>
    </tr>
  </tbody>
</table>
</div>



### 前三个分位数区间不满足条件，后两个区间中数量最多的颜色的确是均重价格中最贵的


```python
df['均重价格']=df['price']/df['carat']
color_result['top'] == [i[1] for i in df.groupby(['cuts'
                                ,'color'])['均重价格'].mean().groupby(['cuts']).idxmax().values]
```




    cuts
    (43.0, 60.8]    False
    (60.8, 61.6]    False
    (61.6, 62.1]    False
    (62.1, 62.7]     True
    (62.7, 79.0]     True
    Name: top, dtype: bool



### (c) 结果见下：


```python
df = df.drop(columns='均重价格')
cuts = pd.cut(df['carat'],bins=[0,0.5,1,1.5,2,np.inf]) #可选label添加自定义标签
df['cuts'] = cuts
df.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>carat</th>
      <th>color</th>
      <th>depth</th>
      <th>price</th>
      <th>cuts</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.23</td>
      <td>E</td>
      <td>61.5</td>
      <td>326</td>
      <td>(0.0, 0.5]</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.21</td>
      <td>E</td>
      <td>59.8</td>
      <td>326</td>
      <td>(0.0, 0.5]</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.23</td>
      <td>E</td>
      <td>56.9</td>
      <td>327</td>
      <td>(0.0, 0.5]</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.29</td>
      <td>I</td>
      <td>62.4</td>
      <td>334</td>
      <td>(0.0, 0.5]</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.31</td>
      <td>J</td>
      <td>63.3</td>
      <td>335</td>
      <td>(0.0, 0.5]</td>
    </tr>
  </tbody>
</table>
</div>




```python
def f(nums):
    if not nums:        
        return 0
    res = 1                            
    cur_len = 1                        
    for i in range(1, len(nums)):      
        if nums[i-1] < nums[i]:        
            cur_len += 1                
            res = max(cur_len, res)     
        else:                       
            cur_len = 1                 
    return res
```


```python
for name,group in df.groupby('cuts'):
    group = group.sort_values(by='depth')
    s = group['price']
    print(name,f(s.tolist()))
```

    (0.0, 0.5] 8
    (0.5, 1.0] 8
    (1.0, 1.5] 7
    (1.5, 2.0] 11
    (2.0, inf] 7
    

### (d) 计算结果如下：


```python
for name,group in df[['carat','price','color']].groupby('color'):
    L1 = np.array([np.ones(group.shape[0]),group['carat']]).reshape(2,group.shape[0])
    L2 = group['price']
    result = (np.linalg.inv(L1.dot(L1.T)).dot(L1)).dot(L2).reshape(2,1)
    print('当颜色为%s时，截距项为：%f，回归系数为：%f'%(name,result[0],result[1]))
```

    当颜色为D时，截距项为：-2361.017152，回归系数为：8408.353126
    当颜色为E时，截距项为：-2381.049600，回归系数为：8296.212783
    当颜色为F时，截距项为：-2665.806191，回归系数为：8676.658344
    当颜色为G时，截距项为：-2575.527643，回归系数为：8525.345779
    当颜色为H时，截距项为：-2460.418046，回归系数为：7619.098320
    当颜色为I时，截距项为：-2878.150356，回归系数为：7761.041169
    当颜色为J时，截距项为：-2920.603337，回归系数为：7094.192092
    

## 第3章：练习二

### (a)


```python
df = pd.read_csv('data/Drugs.csv')
df.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>YYYY</th>
      <th>State</th>
      <th>COUNTY</th>
      <th>SubstanceName</th>
      <th>DrugReports</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2010</td>
      <td>VA</td>
      <td>ACCOMACK</td>
      <td>Propoxyphene</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2010</td>
      <td>OH</td>
      <td>ADAMS</td>
      <td>Morphine</td>
      <td>9</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2010</td>
      <td>PA</td>
      <td>ADAMS</td>
      <td>Methadone</td>
      <td>2</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2010</td>
      <td>VA</td>
      <td>ALEXANDRIA CITY</td>
      <td>Heroin</td>
      <td>5</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2010</td>
      <td>PA</td>
      <td>ALLEGHENY</td>
      <td>Hydromorphone</td>
      <td>5</td>
    </tr>
  </tbody>
</table>
</div>




```python
idx=pd.IndexSlice
for i in range(2010,2018):
    county = (df.groupby(['COUNTY','YYYY']).sum().loc[idx[:,i],:].idxmax()[0][0])
    state = df.query('COUNTY == "%s"'%county)['State'].iloc[0]
    state_true = df.groupby(['State','YYYY']).sum().loc[idx[:,i],:].idxmax()[0][0]
    if state==state_true:
        print('在%d年，%s县的报告数最多，它所属的州%s也是报告数最多的'%(i,county,state))
    else:
        print('在%d年，%s县的报告数最多，但它所属的州%s不是报告数最多的，%s州报告数最多'%(i,county,state,state_true))
```

    在2010年，PHILADELPHIA县的报告数最多，它所属的州PA也是报告数最多的
    在2011年，PHILADELPHIA县的报告数最多，但它所属的州PA不是报告数最多的，OH州报告数最多
    在2012年，PHILADELPHIA县的报告数最多，但它所属的州PA不是报告数最多的，OH州报告数最多
    在2013年，PHILADELPHIA县的报告数最多，但它所属的州PA不是报告数最多的，OH州报告数最多
    在2014年，PHILADELPHIA县的报告数最多，但它所属的州PA不是报告数最多的，OH州报告数最多
    在2015年，PHILADELPHIA县的报告数最多，但它所属的州PA不是报告数最多的，OH州报告数最多
    在2016年，HAMILTON县的报告数最多，它所属的州OH也是报告数最多的
    在2017年，HAMILTON县的报告数最多，它所属的州OH也是报告数最多的
    

### (b) OH州增加最多，Heroin是增量最大的，但增幅最大的是Acetyl fentanyl


```python
df_b = df[(df['YYYY'].isin([2014,2015]))&(df['SubstanceName']=='Heroin')]
df_add = df_b.groupby(['YYYY','State']).sum()
(df_add.loc[2015]-df_add.loc[2014]).idxmax()
```




    DrugReports    OH
    dtype: object




```python
df_b = df[(df['YYYY'].isin([2014,2015]))&(df['State']=='OH')]
df_add = df_b.groupby(['YYYY','SubstanceName']).sum()
display((df_add.loc[2015]-df_add.loc[2014]).idxmax()) #这里利用了索引对齐的特点
display((df_add.loc[2015]/df_add.loc[2014]).idxmax())
```


    DrugReports    Heroin
    dtype: object



    DrugReports    Acetyl fentanyl
    dtype: object


## 第4章：练习一

### (a)


```python
df = pd.read_csv('data/Drugs.csv',index_col=['State','COUNTY']).sort_index()
df.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>YYYY</th>
      <th>SubstanceName</th>
      <th>DrugReports</th>
    </tr>
    <tr>
      <th>State</th>
      <th>COUNTY</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">KY</th>
      <th>ADAIR</th>
      <td>2010</td>
      <td>Methadone</td>
      <td>1</td>
    </tr>
    <tr>
      <th>ADAIR</th>
      <td>2010</td>
      <td>Hydrocodone</td>
      <td>6</td>
    </tr>
    <tr>
      <th>ADAIR</th>
      <td>2011</td>
      <td>Oxycodone</td>
      <td>4</td>
    </tr>
    <tr>
      <th>ADAIR</th>
      <td>2011</td>
      <td>Buprenorphine</td>
      <td>3</td>
    </tr>
    <tr>
      <th>ADAIR</th>
      <td>2011</td>
      <td>Morphine</td>
      <td>2</td>
    </tr>
  </tbody>
</table>
</div>




```python
result = pd.pivot_table(df,index=['State','COUNTY','SubstanceName']
                 ,columns='YYYY'
                 ,values='DrugReports',fill_value='-').reset_index().rename_axis(columns={'YYYY':''})
result.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>State</th>
      <th>COUNTY</th>
      <th>SubstanceName</th>
      <th>2010</th>
      <th>2011</th>
      <th>2012</th>
      <th>2013</th>
      <th>2014</th>
      <th>2015</th>
      <th>2016</th>
      <th>2017</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>KY</td>
      <td>ADAIR</td>
      <td>Buprenorphine</td>
      <td>-</td>
      <td>3</td>
      <td>5</td>
      <td>4</td>
      <td>27</td>
      <td>5</td>
      <td>7</td>
      <td>10</td>
    </tr>
    <tr>
      <th>1</th>
      <td>KY</td>
      <td>ADAIR</td>
      <td>Codeine</td>
      <td>-</td>
      <td>-</td>
      <td>1</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>KY</td>
      <td>ADAIR</td>
      <td>Fentanyl</td>
      <td>-</td>
      <td>-</td>
      <td>1</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
    </tr>
    <tr>
      <th>3</th>
      <td>KY</td>
      <td>ADAIR</td>
      <td>Heroin</td>
      <td>-</td>
      <td>-</td>
      <td>1</td>
      <td>2</td>
      <td>-</td>
      <td>1</td>
      <td>-</td>
      <td>2</td>
    </tr>
    <tr>
      <th>4</th>
      <td>KY</td>
      <td>ADAIR</td>
      <td>Hydrocodone</td>
      <td>6</td>
      <td>9</td>
      <td>10</td>
      <td>10</td>
      <td>9</td>
      <td>7</td>
      <td>11</td>
      <td>3</td>
    </tr>
  </tbody>
</table>
</div>



### (b)


```python
result_melted = result.melt(id_vars=result.columns[:3],value_vars=result.columns[-8:]
                ,var_name='YYYY',value_name='DrugReports').query('DrugReports != "-"')
result2 = result_melted.sort_values(by=['State','COUNTY','YYYY'
                                    ,'SubstanceName']).reset_index().drop(columns='index')
#下面其实无关紧要，只是交换两个列再改一下类型（因为‘-’所以type变成object了）
cols = list(result2.columns)
a, b = cols.index('SubstanceName'), cols.index('YYYY')
cols[b], cols[a] = cols[a], cols[b]
result2 = result2[cols].astype({'DrugReports':'int','YYYY':'int'})
result2.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>State</th>
      <th>COUNTY</th>
      <th>YYYY</th>
      <th>SubstanceName</th>
      <th>DrugReports</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>KY</td>
      <td>ADAIR</td>
      <td>2010</td>
      <td>Hydrocodone</td>
      <td>6</td>
    </tr>
    <tr>
      <th>1</th>
      <td>KY</td>
      <td>ADAIR</td>
      <td>2010</td>
      <td>Methadone</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>KY</td>
      <td>ADAIR</td>
      <td>2011</td>
      <td>Buprenorphine</td>
      <td>3</td>
    </tr>
    <tr>
      <th>3</th>
      <td>KY</td>
      <td>ADAIR</td>
      <td>2011</td>
      <td>Hydrocodone</td>
      <td>9</td>
    </tr>
    <tr>
      <th>4</th>
      <td>KY</td>
      <td>ADAIR</td>
      <td>2011</td>
      <td>Morphine</td>
      <td>2</td>
    </tr>
  </tbody>
</table>
</div>




```python
df_tidy = df.reset_index().sort_values(by=result2.columns[:4].tolist()).reset_index().drop(columns='index')
df_tidy.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>State</th>
      <th>COUNTY</th>
      <th>YYYY</th>
      <th>SubstanceName</th>
      <th>DrugReports</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>KY</td>
      <td>ADAIR</td>
      <td>2010</td>
      <td>Hydrocodone</td>
      <td>6</td>
    </tr>
    <tr>
      <th>1</th>
      <td>KY</td>
      <td>ADAIR</td>
      <td>2010</td>
      <td>Methadone</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>KY</td>
      <td>ADAIR</td>
      <td>2011</td>
      <td>Buprenorphine</td>
      <td>3</td>
    </tr>
    <tr>
      <th>3</th>
      <td>KY</td>
      <td>ADAIR</td>
      <td>2011</td>
      <td>Hydrocodone</td>
      <td>9</td>
    </tr>
    <tr>
      <th>4</th>
      <td>KY</td>
      <td>ADAIR</td>
      <td>2011</td>
      <td>Morphine</td>
      <td>2</td>
    </tr>
  </tbody>
</table>
</div>




```python
df_tidy.equals(result2)
```




    True



## 第4章：练习二

### (a)


```python
df = pd.read_csv('data/Earthquake.csv')
df = df.sort_values(by=df.columns.tolist()[:3]).sort_index(axis=1).reset_index().drop(columns='index')
df.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>方向</th>
      <th>日期</th>
      <th>时间</th>
      <th>深度</th>
      <th>烈度</th>
      <th>经度</th>
      <th>维度</th>
      <th>距离</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>south_east</td>
      <td>1912.08.09</td>
      <td>12:29:00 AM</td>
      <td>16.0</td>
      <td>6.7</td>
      <td>27.2</td>
      <td>40.6</td>
      <td>4.3</td>
    </tr>
    <tr>
      <th>1</th>
      <td>south_west</td>
      <td>1912.08.10</td>
      <td>12:23:00 AM</td>
      <td>15.0</td>
      <td>6.0</td>
      <td>27.1</td>
      <td>40.6</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>south_west</td>
      <td>1912.08.10</td>
      <td>12:30:00 AM</td>
      <td>15.0</td>
      <td>5.2</td>
      <td>27.1</td>
      <td>40.6</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>south_east</td>
      <td>1912.08.11</td>
      <td>12:19:04 AM</td>
      <td>30.0</td>
      <td>4.9</td>
      <td>27.2</td>
      <td>40.6</td>
      <td>4.3</td>
    </tr>
    <tr>
      <th>4</th>
      <td>south_west</td>
      <td>1912.08.11</td>
      <td>12:20:00 AM</td>
      <td>15.0</td>
      <td>4.5</td>
      <td>27.1</td>
      <td>40.6</td>
      <td>2.0</td>
    </tr>
  </tbody>
</table>
</div>




```python
result = pd.pivot_table(df,index=['日期','时间','维度','经度']
            ,columns='方向'
            ,values=['烈度','深度','距离'],fill_value='-').stack(level=0).rename_axis(index={None:'地震参数'})
result.head(6)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th>方向</th>
      <th>east</th>
      <th>north</th>
      <th>north_east</th>
      <th>north_west</th>
      <th>south</th>
      <th>south_east</th>
      <th>south_west</th>
      <th>west</th>
    </tr>
    <tr>
      <th>日期</th>
      <th>时间</th>
      <th>维度</th>
      <th>经度</th>
      <th>地震参数</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="3" valign="top">1912.08.09</th>
      <th rowspan="3" valign="top">12:29:00 AM</th>
      <th rowspan="3" valign="top">40.6</th>
      <th rowspan="3" valign="top">27.2</th>
      <th>深度</th>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>16</td>
      <td>-</td>
      <td>-</td>
    </tr>
    <tr>
      <th>烈度</th>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>6.7</td>
      <td>-</td>
      <td>-</td>
    </tr>
    <tr>
      <th>距离</th>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>4.3</td>
      <td>-</td>
      <td>-</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">1912.08.10</th>
      <th rowspan="3" valign="top">12:23:00 AM</th>
      <th rowspan="3" valign="top">40.6</th>
      <th rowspan="3" valign="top">27.1</th>
      <th>深度</th>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>15</td>
      <td>-</td>
    </tr>
    <tr>
      <th>烈度</th>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>6</td>
      <td>-</td>
    </tr>
    <tr>
      <th>距离</th>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>2</td>
      <td>-</td>
    </tr>
  </tbody>
</table>
</div>



### (b)


```python
df_result = result.unstack().stack(0)[(~(result.unstack().stack(0)=='-')).any(1)].reset_index()
df_result.columns.name=None
df_result = df_result.sort_index(axis=1).astype({'深度':'float64','烈度':'float64','距离':'float64'})
df_result.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>方向</th>
      <th>日期</th>
      <th>时间</th>
      <th>深度</th>
      <th>烈度</th>
      <th>经度</th>
      <th>维度</th>
      <th>距离</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>south_east</td>
      <td>1912.08.09</td>
      <td>12:29:00 AM</td>
      <td>16.0</td>
      <td>6.7</td>
      <td>27.2</td>
      <td>40.6</td>
      <td>4.3</td>
    </tr>
    <tr>
      <th>1</th>
      <td>south_west</td>
      <td>1912.08.10</td>
      <td>12:23:00 AM</td>
      <td>15.0</td>
      <td>6.0</td>
      <td>27.1</td>
      <td>40.6</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>south_west</td>
      <td>1912.08.10</td>
      <td>12:30:00 AM</td>
      <td>15.0</td>
      <td>5.2</td>
      <td>27.1</td>
      <td>40.6</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>south_east</td>
      <td>1912.08.11</td>
      <td>12:19:04 AM</td>
      <td>30.0</td>
      <td>4.9</td>
      <td>27.2</td>
      <td>40.6</td>
      <td>4.3</td>
    </tr>
    <tr>
      <th>4</th>
      <td>south_west</td>
      <td>1912.08.11</td>
      <td>12:20:00 AM</td>
      <td>15.0</td>
      <td>4.5</td>
      <td>27.1</td>
      <td>40.6</td>
      <td>2.0</td>
    </tr>
  </tbody>
</table>
</div>




```python
df_result.astype({'深度':'float64','烈度':'float64','距离':'float64'},copy=False).dtypes
```




    方向     object
    日期     object
    时间     object
    深度    float64
    烈度    float64
    经度    float64
    维度    float64
    距离    float64
    dtype: object




```python
df.equals(df_result)
```




    True



## 第5章：练习一

### (a)


```python
df1 = pd.read_csv('data/Employee1.csv')
df2 = pd.read_csv('data/Employee2.csv')
df1.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Company</th>
      <th>Name</th>
      <th>Age</th>
      <th>Height</th>
      <th>Weight</th>
      <th>Salary</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>A</td>
      <td>a1</td>
      <td>47</td>
      <td>188</td>
      <td>63.7</td>
      <td>25819</td>
    </tr>
    <tr>
      <th>1</th>
      <td>A</td>
      <td>a3</td>
      <td>39</td>
      <td>172</td>
      <td>55.9</td>
      <td>21983</td>
    </tr>
    <tr>
      <th>2</th>
      <td>A</td>
      <td>a4</td>
      <td>43</td>
      <td>158</td>
      <td>62.5</td>
      <td>21755</td>
    </tr>
    <tr>
      <th>3</th>
      <td>A</td>
      <td>a6</td>
      <td>42</td>
      <td>182</td>
      <td>76.9</td>
      <td>17354</td>
    </tr>
    <tr>
      <th>4</th>
      <td>A</td>
      <td>a7</td>
      <td>49</td>
      <td>171</td>
      <td>94.6</td>
      <td>6177</td>
    </tr>
  </tbody>
</table>
</div>




```python
df2.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Company</th>
      <th>Name</th>
      <th>Age</th>
      <th>Height</th>
      <th>Weight</th>
      <th>Salary</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>A</td>
      <td>a1</td>
      <td>30</td>
      <td>156</td>
      <td>91.2</td>
      <td>28133</td>
    </tr>
    <tr>
      <th>1</th>
      <td>A</td>
      <td>a2</td>
      <td>50</td>
      <td>190</td>
      <td>83.4</td>
      <td>6673</td>
    </tr>
    <tr>
      <th>2</th>
      <td>A</td>
      <td>a3</td>
      <td>34</td>
      <td>168</td>
      <td>96.6</td>
      <td>16503</td>
    </tr>
    <tr>
      <th>3</th>
      <td>A</td>
      <td>a5</td>
      <td>51</td>
      <td>176</td>
      <td>97.2</td>
      <td>23294</td>
    </tr>
    <tr>
      <th>4</th>
      <td>A</td>
      <td>a6</td>
      <td>37</td>
      <td>183</td>
      <td>93.2</td>
      <td>19256</td>
    </tr>
  </tbody>
</table>
</div>




```python
L = list(set(df1['Name']).intersection(set(df2['Name'])))
L
```




    ['b7',
     'e8',
     'd10',
     'c12',
     'b15',
     'b3',
     'a1',
     'd5',
     'c13',
     'e10',
     'c3',
     'a3',
     'b1',
     'c10',
     'a6',
     'e11']



### (b)


```python
df_b1 = df1[~df1['Name'].isin(L)]
df_b2 = df2[~df2['Name'].isin(L)]
df_b = pd.concat([df_b1,df_b2]).set_index('Name')
df_b.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Company</th>
      <th>Age</th>
      <th>Height</th>
      <th>Weight</th>
      <th>Salary</th>
    </tr>
    <tr>
      <th>Name</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>a4</th>
      <td>A</td>
      <td>43</td>
      <td>158</td>
      <td>62.5</td>
      <td>21755</td>
    </tr>
    <tr>
      <th>a7</th>
      <td>A</td>
      <td>49</td>
      <td>171</td>
      <td>94.6</td>
      <td>6177</td>
    </tr>
    <tr>
      <th>a8</th>
      <td>A</td>
      <td>51</td>
      <td>168</td>
      <td>89.5</td>
      <td>3246</td>
    </tr>
    <tr>
      <th>a9</th>
      <td>A</td>
      <td>36</td>
      <td>186</td>
      <td>62.8</td>
      <td>3569</td>
    </tr>
    <tr>
      <th>a13</th>
      <td>A</td>
      <td>58</td>
      <td>190</td>
      <td>75.9</td>
      <td>21854</td>
    </tr>
  </tbody>
</table>
</div>



### (c)


```python
df1 = pd.read_csv('data/Employee1.csv')
df2 = pd.read_csv('data/Employee2.csv')
df1['重复'] = ['Y_1' if df1.loc[i,'Name'] in L else 'N' for i in range(df1.shape[0])]
df2['重复'] = ['Y_2' if df2.loc[i,'Name'] in L else 'N' for i in range(df2.shape[0])]
df1 = df1.set_index(['Name','重复'])
df2 = df2.set_index(['Name','重复'])
df_c = pd.concat([df1,df2])
result = pd.DataFrame({'Company':[],'Name':[],'Age':[],'Height':[],'Weight':[],'Salary':[]})
group = df_c.groupby(['Company','重复'])
for i in L:
    first = group.get_group((i[0].upper(),'Y_1')).reset_index(level=1).loc[i,:][-4:]
    second = group.get_group((i[0].upper(),'Y_2')).reset_index(level=1).loc[i,:][-4:]
    mean = group.get_group((i[0].upper(),'N')).reset_index(level=1).mean()
    final = [i[0].upper(),i]
    for j in range(4):
        final.append(first[j] if abs(first[j]-mean[j])<abs(second[j]-mean[j]) else second[j])
    result = pd.concat([result,pd.DataFrame({result.columns.tolist()[k]:[final[k]] for k in range(6)})])
result = pd.concat([result.set_index('Name'),df_b])
for i in list('abcde'):
    for j in range(1,17):
        item = i+str(j)
        if item not in result.index:
            result = pd.concat([result,pd.DataFrame({'Company':[i.upper()],'Name':[item]
                 ,'Age':[np.nan],'Height':[np.nan],'Weight':[np.nan],'Salary':[np.nan]}).set_index('Name')])
result['Number'] = [int(i[1:]) for i in result.index]
result.reset_index().drop(columns='Name').set_index(['Company','Number']).sort_index()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>Age</th>
      <th>Height</th>
      <th>Weight</th>
      <th>Salary</th>
    </tr>
    <tr>
      <th>Company</th>
      <th>Number</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">A</th>
      <th>1</th>
      <td>47.0</td>
      <td>188.0</td>
      <td>91.2</td>
      <td>25819.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>50.0</td>
      <td>190.0</td>
      <td>83.4</td>
      <td>6673.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>39.0</td>
      <td>172.0</td>
      <td>96.6</td>
      <td>16503.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>43.0</td>
      <td>158.0</td>
      <td>62.5</td>
      <td>21755.0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>51.0</td>
      <td>176.0</td>
      <td>97.2</td>
      <td>23294.0</td>
    </tr>
    <tr>
      <th>...</th>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th rowspan="5" valign="top">E</th>
      <th>12</th>
      <td>54.0</td>
      <td>157.0</td>
      <td>79.4</td>
      <td>18490.0</td>
    </tr>
    <tr>
      <th>13</th>
      <td>57.0</td>
      <td>180.0</td>
      <td>54.8</td>
      <td>26837.0</td>
    </tr>
    <tr>
      <th>14</th>
      <td>39.0</td>
      <td>163.0</td>
      <td>83.0</td>
      <td>20554.0</td>
    </tr>
    <tr>
      <th>15</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>16</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>80 rows × 4 columns</p>
</div>



## 第5章：练习二

### (a)


```python
df1 = pd.read_csv('data/Course1.csv')
df2 = pd.read_csv('data/Course2.csv')
df_a11,df_a12,df_a21,df_a22 =0,0,0,0
df_a11= df1.query('课程类别 in ["学科基础课","专业必修课","专业选修课"]')
df_a12= df1.query('课程类别 not in ["学科基础课","专业必修课","专业选修课"]')
df_a21= df2.query('课程类别 in ["学科基础课","专业必修课","专业选修课"]')
df_a22= df2.query('课程类别 not in ["学科基础课","专业必修课","专业选修课"]')
df_a11.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>课程名字</th>
      <th>课程类别</th>
      <th>学分</th>
      <th>分数</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>云计算应用与开发</td>
      <td>专业选修课</td>
      <td>3</td>
      <td>96.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>社会计算</td>
      <td>专业选修课</td>
      <td>3</td>
      <td>78.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>深度学习</td>
      <td>专业选修课</td>
      <td>3</td>
      <td>75.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>人工智能导论</td>
      <td>专业必修课</td>
      <td>3</td>
      <td>84.0</td>
    </tr>
    <tr>
      <th>6</th>
      <td>数据结构与算法</td>
      <td>学科基础课</td>
      <td>5</td>
      <td>82.0</td>
    </tr>
  </tbody>
</table>
</div>



### (b)


```python
special = pd.concat([df_a11,df_a21])
common = pd.concat([df_a12,df_a22])
special.query('课程类别 not in ["学科基础课","专业必修课","专业选修课"]')
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>课程名字</th>
      <th>课程类别</th>
      <th>学分</th>
      <th>分数</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>
</div>




```python
common.query('课程类别 in ["学科基础课","专业必修课","专业选修课"]')
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>课程名字</th>
      <th>课程类别</th>
      <th>学分</th>
      <th>分数</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>
</div>



### (c)


```python
df = pd.concat([df1,df2])
special2 = df.query('课程类别 in ["学科基础课","专业必修课","专业选修课"]')
common2 = df.query('课程类别 not in ["学科基础课","专业必修课","专业选修课"]')
(special.equals(special2),common.equals(common2))
```




    (True, True)



### (d)


```python
df['分数'] = df.groupby('课程类别').transform(lambda x: x.fillna(x.mean()))['分数']
df.isnull().all()
```




    课程名字    False
    课程类别    False
    学分      False
    分数      False
    dtype: bool




```python
special3 = df.query('课程类别 in ["学科基础课","专业必修课","专业选修课"]')
common3 = df.query('课程类别 not in ["学科基础课","专业必修课","专业选修课"]')
common3.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>课程名字</th>
      <th>课程类别</th>
      <th>学分</th>
      <th>分数</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>思想道德修养与法律基础</td>
      <td>思政类</td>
      <td>3</td>
      <td>89.0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>中国近代史纲要</td>
      <td>思政类</td>
      <td>3</td>
      <td>97.0</td>
    </tr>
    <tr>
      <th>8</th>
      <td>网球（初）</td>
      <td>体育类</td>
      <td>1</td>
      <td>81.0</td>
    </tr>
    <tr>
      <th>10</th>
      <td>极端性气候与陆地生态系统</td>
      <td>公共任意选修类</td>
      <td>2</td>
      <td>78.0</td>
    </tr>
    <tr>
      <th>13</th>
      <td>游泳（初）</td>
      <td>体育类</td>
      <td>1</td>
      <td>75.0</td>
    </tr>
  </tbody>
</table>
</div>



## 第6章：练习一
### (a)


```python
df = pd.read_csv('data/Missing_data_one.csv').convert_dtypes()
df.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>A</th>
      <th>B</th>
      <th>C</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>not_NaN</td>
      <td>0.922</td>
      <td>4</td>
    </tr>
    <tr>
      <th>1</th>
      <td>not_NaN</td>
      <td>0.700</td>
      <td>&lt;NA&gt;</td>
    </tr>
    <tr>
      <th>2</th>
      <td>not_NaN</td>
      <td>0.503</td>
      <td>8</td>
    </tr>
    <tr>
      <th>3</th>
      <td>not_NaN</td>
      <td>0.938</td>
      <td>4</td>
    </tr>
    <tr>
      <th>4</th>
      <td>not_NaN</td>
      <td>0.952</td>
      <td>10</td>
    </tr>
  </tbody>
</table>
</div>




```python
df.dtypes
```




    A     string
    B    float64
    C      Int64
    dtype: object




```python
df[df['C'].isna()]
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>A</th>
      <th>B</th>
      <th>C</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>not_NaN</td>
      <td>0.700</td>
      <td>&lt;NA&gt;</td>
    </tr>
    <tr>
      <th>5</th>
      <td>not_NaN</td>
      <td>0.972</td>
      <td>&lt;NA&gt;</td>
    </tr>
    <tr>
      <th>11</th>
      <td>not_NaN</td>
      <td>0.736</td>
      <td>&lt;NA&gt;</td>
    </tr>
    <tr>
      <th>19</th>
      <td>not_NaN</td>
      <td>0.684</td>
      <td>&lt;NA&gt;</td>
    </tr>
    <tr>
      <th>21</th>
      <td>not_NaN</td>
      <td>0.913</td>
      <td>&lt;NA&gt;</td>
    </tr>
  </tbody>
</table>
</div>



### (b)


```python
df = pd.read_csv('data/Missing_data_one.csv').convert_dtypes()
total_b = df['B'].sum()
min_b = df['B'].min()
df['A'] = pd.Series(list(zip(df['A'].values
                    ,df['B'].values))).apply(lambda x:x[0] if np.random.rand()>0.25*x[1]/min_b else np.nan)
df.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>A</th>
      <th>B</th>
      <th>C</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>not_NaN</td>
      <td>0.922</td>
      <td>4</td>
    </tr>
    <tr>
      <th>1</th>
      <td>not_NaN</td>
      <td>0.700</td>
      <td>&lt;NA&gt;</td>
    </tr>
    <tr>
      <th>2</th>
      <td>not_NaN</td>
      <td>0.503</td>
      <td>8</td>
    </tr>
    <tr>
      <th>3</th>
      <td>NaN</td>
      <td>0.938</td>
      <td>4</td>
    </tr>
    <tr>
      <th>4</th>
      <td>NaN</td>
      <td>0.952</td>
      <td>10</td>
    </tr>
  </tbody>
</table>
</div>



## 第6章：练习二

### (a)


```python
df = pd.read_csv('data/Missing_data_two.csv')
df.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>编号</th>
      <th>地区</th>
      <th>身高</th>
      <th>体重</th>
      <th>年龄</th>
      <th>工资</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>A</td>
      <td>157.50</td>
      <td>NaN</td>
      <td>47.0</td>
      <td>15905.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>B</td>
      <td>202.00</td>
      <td>91.80</td>
      <td>25.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>C</td>
      <td>169.09</td>
      <td>62.18</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>A</td>
      <td>166.61</td>
      <td>59.95</td>
      <td>77.0</td>
      <td>5434.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>B</td>
      <td>185.19</td>
      <td>NaN</td>
      <td>62.0</td>
      <td>4242.0</td>
    </tr>
  </tbody>
</table>
</div>




```python
df.isna().sum()/df.shape[0]
```




    编号    0.000000
    地区    0.000000
    身高    0.000000
    体重    0.222222
    年龄    0.250000
    工资    0.222222
    dtype: float64




```python
df_not2na = df[df.iloc[:,-3:].isna().sum(1)<=1]
df_not2na.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>编号</th>
      <th>地区</th>
      <th>身高</th>
      <th>体重</th>
      <th>年龄</th>
      <th>工资</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>A</td>
      <td>157.50</td>
      <td>NaN</td>
      <td>47.0</td>
      <td>15905.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>B</td>
      <td>202.00</td>
      <td>91.80</td>
      <td>25.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>A</td>
      <td>166.61</td>
      <td>59.95</td>
      <td>77.0</td>
      <td>5434.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>B</td>
      <td>185.19</td>
      <td>NaN</td>
      <td>62.0</td>
      <td>4242.0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>6</td>
      <td>A</td>
      <td>187.13</td>
      <td>78.42</td>
      <td>55.0</td>
      <td>13959.0</td>
    </tr>
  </tbody>
</table>
</div>



### (b)
#### 分地区，用排序后的身高信息进行线性插值


```python
df_method_1 = df.copy()
for name,group in df_method_1.groupby('地区'):
    df_method_1.loc[group.index,'体重'] = group[['身高','体重']].sort_values(by='身高').interpolate()['体重']
df_method_1['体重'] = df_method_1['体重'].round(decimals=2)
df_method_1.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>编号</th>
      <th>地区</th>
      <th>身高</th>
      <th>体重</th>
      <th>年龄</th>
      <th>工资</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>A</td>
      <td>157.50</td>
      <td>53.58</td>
      <td>47.0</td>
      <td>15905.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>B</td>
      <td>202.00</td>
      <td>91.80</td>
      <td>25.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>C</td>
      <td>169.09</td>
      <td>62.18</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>A</td>
      <td>166.61</td>
      <td>59.95</td>
      <td>77.0</td>
      <td>5434.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>B</td>
      <td>185.19</td>
      <td>81.75</td>
      <td>62.0</td>
      <td>4242.0</td>
    </tr>
  </tbody>
</table>
</div>



## 第7章：练习一
### (a)


```python
df = pd.read_csv('data/String_data_one.csv',index_col='人员编号').astype('str')
df.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>姓名</th>
      <th>国籍</th>
      <th>性别</th>
      <th>出生年</th>
      <th>出生月</th>
      <th>出生日</th>
    </tr>
    <tr>
      <th>人员编号</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>aesfd</td>
      <td>2</td>
      <td>男</td>
      <td>1942</td>
      <td>8</td>
      <td>10</td>
    </tr>
    <tr>
      <th>2</th>
      <td>fasefa</td>
      <td>5</td>
      <td>女</td>
      <td>1985</td>
      <td>10</td>
      <td>4</td>
    </tr>
    <tr>
      <th>3</th>
      <td>aeagd</td>
      <td>4</td>
      <td>女</td>
      <td>1946</td>
      <td>10</td>
      <td>15</td>
    </tr>
    <tr>
      <th>4</th>
      <td>aef</td>
      <td>4</td>
      <td>男</td>
      <td>1999</td>
      <td>5</td>
      <td>13</td>
    </tr>
    <tr>
      <th>5</th>
      <td>eaf</td>
      <td>1</td>
      <td>女</td>
      <td>2010</td>
      <td>6</td>
      <td>24</td>
    </tr>
  </tbody>
</table>
</div>




```python
(df['姓名']+':'+df['国籍']+'国人，性别'
          +df['性别']+'，生于'
          +df['出生年']+'年'
          +df['出生月']+'月'+df['出生日']+'日').to_frame().rename(columns={0:'ID'}).head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ID</th>
    </tr>
    <tr>
      <th>人员编号</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>aesfd:2国人，性别男，生于1942年8月10日</td>
    </tr>
    <tr>
      <th>2</th>
      <td>fasefa:5国人，性别女，生于1985年10月4日</td>
    </tr>
    <tr>
      <th>3</th>
      <td>aeagd:4国人，性别女，生于1946年10月15日</td>
    </tr>
    <tr>
      <th>4</th>
      <td>aef:4国人，性别男，生于1999年5月13日</td>
    </tr>
    <tr>
      <th>5</th>
      <td>eaf:1国人，性别女，生于2010年6月24日</td>
    </tr>
  </tbody>
</table>
</div>



### (b)


```python
L_year = list('零一二三四五六七八九')
L_one = [s.strip() for s in list('  二三四五六七八九')]
L_two = [s.strip() for s in list(' 一二三四五六七八九')]
df_new = (df['姓名']+':'+df['国籍']+'国人，性别'+df['性别']+'，生于'
          +df['出生年'].str.replace(r'\d',lambda x:L_year[int(x.group(0))])+'年'
          +df['出生月'].apply(lambda x:x if len(x)==2 else '0'+x)\
                      .str.replace(r'(?P<one>[\d])(?P<two>\d?)',lambda x:L_one[int(x.group('one'))]
                      +bool(int(x.group('one')))*'十'+L_two[int(x.group('two'))])+'月'
          +df['出生日'].apply(lambda x:x if len(x)==2 else '0'+x)\
                      .str.replace(r'(?P<one>[\d])(?P<two>\d?)',lambda x:L_one[int(x.group('one'))]
                      +bool(int(x.group('one')))*'十'+L_two[int(x.group('two'))])+'日')\
          .to_frame().rename(columns={0:'ID'})
df_new.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ID</th>
    </tr>
    <tr>
      <th>人员编号</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>aesfd:2国人，性别男，生于一九四二年八月十日</td>
    </tr>
    <tr>
      <th>2</th>
      <td>fasefa:5国人，性别女，生于一九八五年十月四日</td>
    </tr>
    <tr>
      <th>3</th>
      <td>aeagd:4国人，性别女，生于一九四六年十月十五日</td>
    </tr>
    <tr>
      <th>4</th>
      <td>aef:4国人，性别男，生于一九九九年五月十三日</td>
    </tr>
    <tr>
      <th>5</th>
      <td>eaf:1国人，性别女，生于二零一零年六月二十四日</td>
    </tr>
  </tbody>
</table>
</div>



### (c)


```python
dic_year = {i[0]:i[1] for i in zip(list('零一二三四五六七八九'),list('0123456789'))}
dic_two = {i[0]:i[1] for i in zip(list('十一二三四五六七八九'),list('0123456789'))}
dic_one = {'十':'1','二十':'2','三十':'3',None:''}
df_res = df_new['ID'].str.extract(r'(?P<姓名>[a-zA-Z]+):(?P<国籍>[\d])国人，性别(?P<性别>[\w])，生于(?P<出生年>[\w]{4})年(?P<出生月>[\w]+)月(?P<出生日>[\w]+)日')
df_res['出生年'] = df_res['出生年'].str.replace(r'(\w)+',lambda x:''.join([dic_year[x.group(0)[i]] for i in range(4)]))
df_res['出生月'] = df_res['出生月'].str.replace(r'(?P<one>\w?十)?(?P<two>[\w])',lambda x:dic_one[x.group('one')]+dic_two[x.group('two')]).str.replace(r'0','10')
df_res['出生日'] = df_res['出生日'].str.replace(r'(?P<one>\w?十)?(?P<two>[\w])',lambda x:dic_one[x.group('one')]+dic_two[x.group('two')]).str.replace(r'^0','10')
df_res.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>姓名</th>
      <th>国籍</th>
      <th>性别</th>
      <th>出生年</th>
      <th>出生月</th>
      <th>出生日</th>
    </tr>
    <tr>
      <th>人员编号</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>aesfd</td>
      <td>2</td>
      <td>男</td>
      <td>1942</td>
      <td>8</td>
      <td>10</td>
    </tr>
    <tr>
      <th>2</th>
      <td>fasefa</td>
      <td>5</td>
      <td>女</td>
      <td>1985</td>
      <td>10</td>
      <td>4</td>
    </tr>
    <tr>
      <th>3</th>
      <td>aeagd</td>
      <td>4</td>
      <td>女</td>
      <td>1946</td>
      <td>10</td>
      <td>15</td>
    </tr>
    <tr>
      <th>4</th>
      <td>aef</td>
      <td>4</td>
      <td>男</td>
      <td>1999</td>
      <td>5</td>
      <td>13</td>
    </tr>
    <tr>
      <th>5</th>
      <td>eaf</td>
      <td>1</td>
      <td>女</td>
      <td>2010</td>
      <td>6</td>
      <td>24</td>
    </tr>
  </tbody>
</table>
</div>




```python
df_res.equals(df)
```




    True



## 第7章：练习二
#### 看题目可能会觉得疑惑，为什么会有(b)和(c)两道那么水的题，但是其中的坑只有做过/实际数据处理中遇到过才知道

### (a)


```python
df = pd.read_csv('data/String_data_two.csv')
df.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>col1</th>
      <th>col2</th>
      <th>col3</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>鄂尔多斯市第2例确诊患者治愈出院</td>
      <td>19</td>
      <td>363.6923</td>
    </tr>
    <tr>
      <th>1</th>
      <td>云南新增2例，累计124例</td>
      <td>-67</td>
      <td>-152.281</td>
    </tr>
    <tr>
      <th>2</th>
      <td>武汉协和医院14名感染医护出院</td>
      <td>-86</td>
      <td>325.6221</td>
    </tr>
    <tr>
      <th>3</th>
      <td>山东新增9例，累计307例</td>
      <td>-74</td>
      <td>-204.9313</td>
    </tr>
    <tr>
      <th>4</th>
      <td>上海开学日期延至3月</td>
      <td>-95</td>
      <td>4.05</td>
    </tr>
  </tbody>
</table>
</div>




```python
df[df['col1'].str.contains(r'[北京]{2}|[上海]{2}')].head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>col1</th>
      <th>col2</th>
      <th>col3</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>4</th>
      <td>上海开学日期延至3月</td>
      <td>-95</td>
      <td>4.05</td>
    </tr>
    <tr>
      <th>5</th>
      <td>北京新增25例确诊病例，累计确诊253例</td>
      <td>-4</td>
      <td>-289.1719</td>
    </tr>
    <tr>
      <th>6</th>
      <td>上海新增10例，累计243例</td>
      <td>2</td>
      <td>-73.7105</td>
    </tr>
    <tr>
      <th>36</th>
      <td>上海新增14例累计233例</td>
      <td>-55</td>
      <td>-83</td>
    </tr>
    <tr>
      <th>40</th>
      <td>上海新增14例累计233例</td>
      <td>-88</td>
      <td>-99</td>
    </tr>
  </tbody>
</table>
</div>



### (b)


```python
#df['col2'].mean() #报错
df['col2'][~(df['col2'].str.replace(r'-?\d+','True')=='True')] #这三行有问题
```




    309    0-
    396    9`
    485    /7
    Name: col2, dtype: object




```python
df.loc[[309,396,485],'col2'] = [0,9,7]
df['col2'].astype('int').mean()
```




    -0.984



### (c)


```python
#df['col3'].mean() #报错
#df['col3'] #报错
df.columns
```




    Index(['col1', 'col2', 'col3  '], dtype='object')




```python
df.columns = df.columns.str.strip()
df.columns
```




    Index(['col1', 'col2', 'col3'], dtype='object')




```python
df['col3'].head()
```




    0     363.6923
    1     -152.281
    2     325.6221
    3    -204.9313
    4         4.05
    Name: col3, dtype: object




```python
#df['col3'].mean() #报错
df['col3'][~(df['col3'].str.replace(r'-?\d+\.?\d+','True')=='True')]
```




    28      355`.3567
    37             -5
    73              1
    122    9056.\2253
    332    3534.6554{
    370             7
    Name: col3, dtype: object




```python
df.loc[[28,122,332],'col3'] = [355.3567,9056.2253, 3534.6554]
df['col3'].astype('float').mean()
```




    24.707485



## 第8章 练习一

### (a)


```python
df = pd.read_csv('data/Earthquake.csv')
df.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>日期</th>
      <th>时间</th>
      <th>维度</th>
      <th>经度</th>
      <th>方向</th>
      <th>距离</th>
      <th>深度</th>
      <th>烈度</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2003.05.20</td>
      <td>12:17:44 AM</td>
      <td>39.04</td>
      <td>40.38</td>
      <td>west</td>
      <td>0.1</td>
      <td>10.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2007.08.01</td>
      <td>12:03:08 AM</td>
      <td>40.79</td>
      <td>30.09</td>
      <td>west</td>
      <td>0.1</td>
      <td>5.2</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1978.05.07</td>
      <td>12:41:37 AM</td>
      <td>38.58</td>
      <td>27.61</td>
      <td>south_west</td>
      <td>0.1</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1997.03.22</td>
      <td>12:31:45 AM</td>
      <td>39.47</td>
      <td>36.44</td>
      <td>south_west</td>
      <td>0.1</td>
      <td>10.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2000.04.02</td>
      <td>12:57:38 AM</td>
      <td>40.80</td>
      <td>30.24</td>
      <td>south_west</td>
      <td>0.1</td>
      <td>7.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div>




```python
df_a = df.copy()
df_a['深度'] = pd.cut(df_a['深度'], [-1e-10,5,10,15,20,30,50,np.inf],labels=['Ⅰ','Ⅱ','Ⅲ','Ⅳ','Ⅴ','Ⅵ','Ⅶ'])
df_a.set_index('深度').sort_index().head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>日期</th>
      <th>时间</th>
      <th>维度</th>
      <th>经度</th>
      <th>方向</th>
      <th>距离</th>
      <th>烈度</th>
    </tr>
    <tr>
      <th>深度</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Ⅰ</th>
      <td>2009.09.09</td>
      <td>12:54:13 AM</td>
      <td>42.42</td>
      <td>43.03</td>
      <td>north_east</td>
      <td>95.4</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>Ⅰ</th>
      <td>1997.06.16</td>
      <td>12:18:04 AM</td>
      <td>37.92</td>
      <td>29.17</td>
      <td>north_east</td>
      <td>3.2</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>Ⅰ</th>
      <td>2011.10.25</td>
      <td>12:29:45 AM</td>
      <td>38.96</td>
      <td>43.64</td>
      <td>south_east</td>
      <td>1.6</td>
      <td>3.9</td>
    </tr>
    <tr>
      <th>Ⅰ</th>
      <td>1995.07.23</td>
      <td>12:05:04 AM</td>
      <td>37.61</td>
      <td>29.29</td>
      <td>north_east</td>
      <td>3.2</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>Ⅰ</th>
      <td>2013.06.10</td>
      <td>12:39:19 AM</td>
      <td>38.53</td>
      <td>43.85</td>
      <td>south_east</td>
      <td>1.6</td>
      <td>3.7</td>
    </tr>
  </tbody>
</table>
</div>



### (b)


```python
df_a['烈度'] = pd.cut(df_a['烈度'], [-1e-10,3,4,5,np.inf],labels=['Ⅰ','Ⅱ','Ⅲ','Ⅳ'])
df_a.set_index(['深度','烈度']).sort_index().head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>日期</th>
      <th>时间</th>
      <th>维度</th>
      <th>经度</th>
      <th>方向</th>
      <th>距离</th>
    </tr>
    <tr>
      <th>深度</th>
      <th>烈度</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">Ⅰ</th>
      <th>Ⅰ</th>
      <td>1978.05.07</td>
      <td>12:41:37 AM</td>
      <td>38.58</td>
      <td>27.61</td>
      <td>south_west</td>
      <td>0.1</td>
    </tr>
    <tr>
      <th>Ⅰ</th>
      <td>2000.02.07</td>
      <td>12:11:45 AM</td>
      <td>40.05</td>
      <td>34.07</td>
      <td>south_east</td>
      <td>0.1</td>
    </tr>
    <tr>
      <th>Ⅰ</th>
      <td>1971.05.20</td>
      <td>12:08:46 AM</td>
      <td>37.72</td>
      <td>30.00</td>
      <td>north_east</td>
      <td>0.1</td>
    </tr>
    <tr>
      <th>Ⅰ</th>
      <td>1985.01.28</td>
      <td>12:20:56 AM</td>
      <td>38.85</td>
      <td>29.06</td>
      <td>north_east</td>
      <td>0.1</td>
    </tr>
    <tr>
      <th>Ⅰ</th>
      <td>1990.07.05</td>
      <td>12:43:04 AM</td>
      <td>37.87</td>
      <td>29.18</td>
      <td>east</td>
      <td>0.1</td>
    </tr>
  </tbody>
</table>
</div>



## 第8章 练习二


```python
foo = pd.Categorical(['a', 'b'], categories=['a', 'b', 'c'])
bar = pd.Categorical(['d', 'e'], categories=['d', 'e', 'f'])
pd.crosstab(foo, bar)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>col_0</th>
      <th>d</th>
      <th>e</th>
    </tr>
    <tr>
      <th>row_0</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>a</th>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>b</th>
      <td>0</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div>




```python
def my_crosstab(foo,bar):
    num = len(foo)
    s1 = pd.Series([i for i in list(foo.categories.union(set(foo)))],name='1nd var')
    s2 = [i for i in list(bar.categories.union(set(bar)))]
    df = pd.DataFrame({i:[0]*len(s1) for i in s2},index=s1)
    for i in range(num):
        df.at[foo[i],bar[i]] += 1
    return df.rename_axis('2st var',axis=1)
my_crosstab(foo,bar)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>2st var</th>
      <th>d</th>
      <th>e</th>
      <th>f</th>
    </tr>
    <tr>
      <th>1nd var</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>a</th>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>b</th>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>c</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>



## 第9章：练习一


```python
df = pd.read_csv('data/time_series_one.csv', parse_dates=['日期'])
df.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>日期</th>
      <th>销售额</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2017-02-17</td>
      <td>2154</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2017-02-18</td>
      <td>2095</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2017-02-19</td>
      <td>3459</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2017-02-20</td>
      <td>2198</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2017-02-21</td>
      <td>2413</td>
    </tr>
  </tbody>
</table>
</div>



### (a) 周日，注意dayofweek函数结果里0对应周一；6对应周日


```python
df['日期'].dt.dayofweek[df['销售额'].idxmax()]
```




    6



### (b)


```python
holiday = pd.date_range(start='20170501', end='20170503').append(
          pd.date_range(start='20171001', end='20171007')).append(
          pd.date_range(start='20180215', end='20180221')).append(
          pd.date_range(start='20180501', end='20180503')).append(
          pd.date_range(start='20181001', end='20181007')).append(
          pd.date_range(start='20190204', end='20190224')).append(
          pd.date_range(start='20190501', end='20190503')).append(
          pd.date_range(start='20191001', end='20191007'))
result = df[~df['日期'].isin(holiday)].set_index('日期').resample('MS').sum()
result.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>销售额</th>
    </tr>
    <tr>
      <th>日期</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2017-02-01</th>
      <td>31740</td>
    </tr>
    <tr>
      <th>2017-03-01</th>
      <td>80000</td>
    </tr>
    <tr>
      <th>2017-04-01</th>
      <td>74734</td>
    </tr>
    <tr>
      <th>2017-05-01</th>
      <td>76237</td>
    </tr>
    <tr>
      <th>2017-06-01</th>
      <td>80750</td>
    </tr>
  </tbody>
</table>
</div>



### (c)


```python
result = df[df['日期'].dt.dayofweek.isin([5,6])].set_index('日期').resample('QS').sum()
result.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>销售额</th>
    </tr>
    <tr>
      <th>日期</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2017-01-01</th>
      <td>32894</td>
    </tr>
    <tr>
      <th>2017-04-01</th>
      <td>66692</td>
    </tr>
    <tr>
      <th>2017-07-01</th>
      <td>69099</td>
    </tr>
    <tr>
      <th>2017-10-01</th>
      <td>70384</td>
    </tr>
    <tr>
      <th>2018-01-01</th>
      <td>74671</td>
    </tr>
  </tbody>
</table>
</div>



### (d) 这里结果的日期是5天里的最后一天


```python
df_temp = df[~df['日期'].dt.dayofweek.isin([5,6])].set_index('日期').iloc[::-1]
L_temp,date_temp = [],[0]*df_temp.shape[0]
for i in range(df_temp.shape[0]//5):
    L_temp.extend([i]*5)
L_temp.extend([df_temp.shape[0]//5]*(df_temp.shape[0]-df_temp.shape[0]//5*5))
date_temp = pd.Series([i%5==0 for i in range(df_temp.shape[0])])
df_temp['num'] = L_temp
result = pd.DataFrame({'5天总额':df_temp.groupby('num')['销售额'].sum().values},
                       index=df_temp.reset_index()[date_temp]['日期']).iloc[::-1]
result.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>5天总额</th>
    </tr>
    <tr>
      <th>日期</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2017-02-22</th>
      <td>9855</td>
    </tr>
    <tr>
      <th>2017-03-01</th>
      <td>12296</td>
    </tr>
    <tr>
      <th>2017-03-08</th>
      <td>13323</td>
    </tr>
    <tr>
      <th>2017-03-15</th>
      <td>13845</td>
    </tr>
    <tr>
      <th>2017-03-22</th>
      <td>11356</td>
    </tr>
  </tbody>
</table>
</div>



### (e)


```python
from datetime import datetime 
df_temp = df.copy()
df_fri = df.shift(4)[df.shift(4)['日期'].dt.dayofweek==1]['销售额']
df_mon = df.shift(-4)[df.shift(-4)['日期'].dt.dayofweek==5]['销售额']
df_temp.loc[df_fri.index,['销售额']] = df_fri
df_temp.loc[df_mon.index,['销售额']] = df_mon
df_temp.loc[df_temp[df_temp['日期'].dt.year==2018]['日期'][
        df_temp[df_temp['日期'].dt.year==2018]['日期'].apply(
        lambda x:True if datetime.strptime(str(x).split()[0],'%Y-%m-%d').weekday() == 0 
        and 1 <= datetime.strptime(str(x).split()[0],'%Y-%m-%d').day <= 7 else False)].index,:]
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>日期</th>
      <th>销售额</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>318</th>
      <td>2018-01-01</td>
      <td>2863.0</td>
    </tr>
    <tr>
      <th>353</th>
      <td>2018-02-05</td>
      <td>2321.0</td>
    </tr>
    <tr>
      <th>381</th>
      <td>2018-03-05</td>
      <td>2705.0</td>
    </tr>
    <tr>
      <th>409</th>
      <td>2018-04-02</td>
      <td>2487.0</td>
    </tr>
    <tr>
      <th>444</th>
      <td>2018-05-07</td>
      <td>3204.0</td>
    </tr>
    <tr>
      <th>472</th>
      <td>2018-06-04</td>
      <td>2927.0</td>
    </tr>
    <tr>
      <th>500</th>
      <td>2018-07-02</td>
      <td>2574.0</td>
    </tr>
    <tr>
      <th>535</th>
      <td>2018-08-06</td>
      <td>2504.0</td>
    </tr>
    <tr>
      <th>563</th>
      <td>2018-09-03</td>
      <td>2483.0</td>
    </tr>
    <tr>
      <th>591</th>
      <td>2018-10-01</td>
      <td>2431.0</td>
    </tr>
    <tr>
      <th>626</th>
      <td>2018-11-05</td>
      <td>2395.0</td>
    </tr>
    <tr>
      <th>654</th>
      <td>2018-12-03</td>
      <td>2373.0</td>
    </tr>
  </tbody>
</table>
</div>



## 第9章：练习二

### (a)


```python
df = pd.read_csv('data/time_series_one.csv',index_col='日期',parse_dates=['日期'])
df['销售额'].rolling(window=50,min_periods=1).mean().head()
```




    日期
    2017-02-17    2154.000000
    2017-02-18    2124.500000
    2017-02-19    2569.333333
    2017-02-20    2476.500000
    2017-02-21    2463.800000
    Name: 销售额, dtype: float64




```python
df['销售额'].rolling(window=50,min_periods=1).max().head()
```




    日期
    2017-02-17    2154.0
    2017-02-18    2154.0
    2017-02-19    3459.0
    2017-02-20    3459.0
    2017-02-21    3459.0
    Name: 销售额, dtype: float64



### (b)


```python
def f(x):
    if len(x) == 6:
        return 1 if x[-1]>np.mean(x[:-1]) else 0
    else:
        return 0
result_b = df.loc[pd.date_range(start='20171227',end='20181231'),:].rolling(
                                                    window=6,min_periods=1).agg(f)[5:].head()
result_b.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>销售额</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2018-01-01</th>
      <td>1.0</td>
    </tr>
    <tr>
      <th>2018-01-02</th>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2018-01-03</th>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2018-01-04</th>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2018-01-05</th>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div>



### (c) 比较巧合，与(b)的结果一样


```python
def f(x):
    if len(x) == 8:
        return 1 if x[-1]>np.mean(x[:-1][pd.Series([
            False if i in [5,6] else True for i in x[:-1].index.dayofweek],index=x[:-1].index)]) else 0
    else:
        return 0
result_c = df.loc[pd.date_range(start='20171225',end='20181231'),:].rolling(
                                    window=8,min_periods=1).agg(f)[7:].head()
result_c.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>销售额</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2018-01-01</th>
      <td>1.0</td>
    </tr>
    <tr>
      <th>2018-01-02</th>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2018-01-03</th>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2018-01-04</th>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2018-01-05</th>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div>


